**Lets see how to deploy `Jenkins` CI/CD Application in the available cluster.** 

And in this case, we **cannot use active and passive mode** where **Kubernetes** itself will self-heal and recreate the same.  

**In that case, will use `Deployment` object, with `replica=1` where the volume storage gets mounted in `nfs` storage server** using Jenkins.

Because, EVEN THE CLUSTER CRASHES DOWN, THE DATA WILL BE PERSISTENT IN THE `NFS` STORAGE SERVER, where we store data in a remote location even when the POD gets recreated. By controller, where it reschedule the PODs to re-spin again on any other node with the volumes mounted together with no data loss. A fresh set of containers with the same data just a flicker of downtime. 

So Here, will see,
- The manifest - `deployment`
- And how to use `nfs`

Previously, we have saw the practices to handle volumes to persist even the pod or the node crashes.

We are done with the basics. Now will see the same in brief by deploying a Jenkins Service with `Deployment` Object with `NFS` using Jenkins. 

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
	name: jenkins-nfs-deploy
	labels:
		app: cicd-server
		env: prod
		release: v1.0

spec:
# replicas: 3
	selector:
	matchLabels:
		app: cicd-server
		env: prod
		release: v1.0
	template:
		metadata:
			name: jenkins-nfs-deploy
			labels:
				app: cicd-server
				env: prod
				release: v1.0

	spec:
		containers:
		  - name: cicd-server
			image: jenkins/jenkins:lts
			ports:
			- name: cicd-port
			  containerPort: 8080
			  protocol: TCP
			volumeMounts:
			- name: jenkins-nfs
			  mountPath: /var/jenkins_home #var/lib/jenkins
	
	volumes:
	- name: jenkins-nfs
	nfs:
		server: 192.168.0.126
		path: /var/nfs
```

And ensure the path directory exists in the `nfs` server too. Or else
```
ssh username@nfsServerIp
mkdir /var/nfs/volumeName
```

After that, create resource,
```
kubectl create -f /path/to/jenkinsNfsDEploy.yaml
```

Check status,
```
kubectl get deploy,rs,po -o wide
```

`CrashLoopBackOff`. If any issue, troubleshoot be checking the status and logs, to do that,
```
kubectl describe po podName
kubectl events po podName
```

To check logs,
```
kubectl logs podName
```
==**DOES NOT HAVE REQUIRED PERMISSIONS.**==
Throws this, **==WHY?==**
```
INSTALL WARNING: User:  missing rw permissions on JENKINS_HOME: /var/jenkins_home

touch: cannot touch '/var/jenkins_home/copy_reference_file.log': Permission denied

Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?

stream closed EOF for default/jenkins-nfs-deploy-856db8b78b-gttdh (cicd-server)
```

**In the logs, it is telling that we doesn't have enough permissions.** so, the scenario is that, 

Since, One of the container in the deployment object is a writing data and that too is getting stored in `nfs`. THAT WAS THE SETUP RIGHT?, Here,

But who is trying to write that data in that mount nfs container mount? IT IS JENKINS USER. And that doesn't have enough permissions.

>  tldr: `nfs` have permissions only to the root (no permission to no user, no group). But the write container is who are writing the data under the mounted folder (which have permissions only to the root)? JENKINS which doesn't have required permissions to write in a restricted directory which doesnt have the permissions.

Practically two solutions, 
1) change the directory's permission access to users or
2) give the permission to the user. (
What to do, change permissions - groupid 1000)
Will see how we do that,

*Back to `nfs`, cannot give `JENKINS` the permissions cause, it expects the user to be present on the host `nfs`., instead, use `userID`

```
ssh username@nfsServerIpVMIp
```

```
sudo chown -R 1000:1000 /var/nfs/jenkins-nfs(mountDir)
```

And voila. Runs smooth like butter. Verify the same,
```
kubectl get deploy, rs, po -o wide
```

```
kubectl exec -it jenkinsPodName --bash 
```

```
id
```
Output: `uid=0(root) gid=0(root) groups=0(root)`

Expose the same to the application which u deploy. 

Verify `JENKINS` home directory.
```
ca /etc/passwd | grep jenkins
```
Shows the `user permission:homeDir: shell`

ALL GOOD!. WORKS JUST FINE! 

==**now IN ORDER TO ACCESS JENKINS, WILL BE EXPOSING THE `Deployment` Object USING `NODEPORT`**==

For reference:
**WORKFLOW OVERVIEW**
![[Nodeport-workflow.excalidraw]]

WORKFLOW IN BRIEF:
![[Nodeport-workflow-brief.excalidraw]]


```
apiVersion: v1
kind: Service
metadata:
	name: jenkins-nodeport-svc
	labels:
	  app: nodeportsvc
  
spec:
	selector:
	  app: cicd-server
	  env: prod
	  release: v1.0

ports:
	- name: cicd-port
	  port: 80
	  targetPort: 8080
	  protocol: TCP
type: NodePort
```

WITH THIS, WE HAVE SUCCESSFULLY DEPLOYED `JENKINS`.
And use the JENKINS in ease. 

Here, WE DO SO MUCH WORK, ALSO PRODUCING LOT OF DATA, SUCH AS,
- Logs,
- Artifacts
- .csv's
- Configs
- .dotfiles
- Dumps
- Jobs
- Deployment cleanups
- Outputs
- And much more data. 

*What happens if a POD gets deleted, Will K 8 s recreates the POD and these existing workload gets vanished and will all these be new and gets vanished?* 
**Simple. Data is stored well and good in `nfs` server and even after the POD gets deleted and recreated, nothing inside will be washed out.**

To verify, put some workload in the same and delete,
```
kubectl delete po podName
```
And see if anything persist inside still.

THIS IS HOW IT WORKS. 
**Though it is a new pod, the files inside are still intact from the `nfs` server getting utilized here.** With this, we have seen how to deploy Jenkins Application on K 8 s Cluster as a `deployment` object exposed in `nodeport` with the `nfs` volumeType - only one replica. 

If we are trying to run multiple replica on HA setup and such, `nfs` won't allow if one container writing the data and another container assessing the same file, it wont allow.  THAT IS WHY, Jenkins can be deploy as only one replica. 

IF WE ARE LOOKING TO RUN THE SAME IN MULTIPLES O `HA` SETUP - Have to use External LOAD BALANCERS (takes extra work to write scripts, more work and all) or deploy `Jenkinsx`.

SO THIS IS THE SETUP TO DEPLOY `JENKINS` ON K 8 s. 

###### Cleanup,
```
kubectl delete -f /path/to/manifest
```

```
ssh username@nfsServerIpVMIp 
cd /var/nfs/jenkins-master
```


---

