
ðŸ“º [Watch Video](https://www.youtube.com/watch?v=UoOcLXfa8EU)

Are you running Kubernetes in your homelab or in the enterprise? Do you want an easy way to manage and create Kubernetes clusters? Do you want high availability Rancher? Join me as we walk through stalling Rancher on an existing high availability k3s cluster in this step-by-step tutorial.We install Rancher, configure a load balancer, install and configure helm, install cert-manager, configure Rancher, walk through the GUI, scale up our cluster, and set up a health check and liveness check! Join me, itâ€™s easy in this straightforward guide.

## Load Balancer[](https://technotim.live/posts/k3s-ha-install/#load-balancer)

Create a load balancer using `nginx`

`nginx.conf`

```nginx
`#uncomment this next line if you are NOT running nginx in docker 
#load_module /usr/lib/nginx/modules/ngx_stream_module.so; 

events {}

stream {
   upstream k3s_servers {
   	server 192.168.60.20:6443;     
   	server 192.168.60.21:6443;   
   	}
   	
   	server {
   		listen 6443;
   		proxy_pass k3s_servers;
   	}
}
```

## k3s servers[](https://technotim.live/posts/k3s-ha-install/#k3s-servers)

On your k3s servers

```
export K3S_DATASTORE_ENDPOINT='mysql://username:password@tcp(database_ip_or_hostname:port)/database'
````

_Note: Itâ€™s advised you consult the [Rancher Support Matrix](https://rancher.com/support-maintenance-terms/all-supported-versions) to get the recommended version for all Rancher dependencies._

then,
```sh
curl -sfL https://get.k3s.io | sh -s - server --node-taint CriticalAddonsOnly=true:NoExecute --tls-san load_balancer_ip_or_hostname
```

test with
```sh
curl -sfL https://get.k3s.io | sh -s - server --node-taint CriticalAddonsOnly=true:NoExecute --tls-san load_balancer_ip_or_hostname
```

to add additional servers, get token from first server
```sh
sudo cat /var/lib/rancher/k3s/server/node-token
```

then run the same command but add the token (replace SECRET with token from previous command)

```sh
curl -sfL https://get.k3s.io \| sh -s - server --token=SECRET --node-taint CriticalAddonsOnly=true:NoExecute --tls-san load_balancer_ip_or_hostname
```

on agents / workers, to run without `sudo`
```sh
sudo chmod 644 /etc/rancher/k3s/k3s.yaml
```
Get token,
```
sudo cat /var/lib/rancher/k3s/server/node-token
```

## k3s agents / workers[](https://technotim.live/posts/k3s-ha-install/#k3s-agents--workers)

```
curl -sfL https://get.k3s.io \| K3S_URL=https://load_balancer_ip_or_hostname:6443 K3S_TOKEN=mynodetoken sh -
```


##### other[](https://technotim.live/posts/k3s-ha-install/#other)

To install `kubectl` [see this link](https://kubernetes.io/docs/tasks/tools/install-kubectl/)

`kubeconfig` location on server - `/etc/rancher/k3s/k3s.yaml`
```
sudo cat /etc/rancher/k3s/k3s.yaml
```

copy contents to your dev machine : `~/.kube/config `
Be sure to update the `server:` to your load balancer ip or hostname

##### kubernetes dashboard[](https://technotim.live/posts/k3s-ha-install/#kubernetes-dashboard)

check [releases](https://github.com/kubernetes/dashboard/releases) for the command to use. At time or filming itâ€™s:

```
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.4/aio/deploy/recommended.yaml
```

### Dashboard RBAC Configuration[](https://technotim.live/posts/k3s-ha-install/#dashboard-rbac-configuration)
1) `dashboard.admin-user.yml
```
apiVersion: v1
kind: ServiceAccount
metadata:
   name: admin-user
   namespace: kubernetes-dashboard`
```

2) `dashboard.admin-user-role.yml`
```
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
   name: admin-user
   roleRef:
      apiGroup: rbac.authorization.k8s.io
	  kind: ClusterRole
	  name: cluster-admin
   subjects:
    - kind: ServiceAccount
    name: admin-user
    namespace: kubernetes-dashboard`
```

Deploy the `admin-user` configuration: 
(if youâ€™re doing this from your dev machine, remove `sudo k3s` and just use `kubectl`)
```
sudo k3s kubectl create -f dashboard.admin-user.yml -f dashboard.admin-user-role.yml
```

get bearer token:
```
sudo k3s kubectl -n kubernetes-dashboard create token admin-user
```

start dashboard locally:
```
sudo k3s kubectl proxy
```

Then you can sign in at this URL using your token we got in the previous step:
```
http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
```

hereâ€™s `testdeploy.yml` you can use
```
apiVersion: apps/v1
kind: Deployment
metadata:
   name: mysite
   labels:
   	app: mysite
spec:
	replicas: 1
	selector:
		matchLabels:
			app: mysite
	template:
		metadata:
			labels:
			app : mysite
		spec:
			containers:
				- name : mysite          
				  image: nginx
				  ports:
				    - containerPort: 80
```


---

